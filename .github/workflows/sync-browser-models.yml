name: Sync Browser Models

on:
  workflow_dispatch:
    inputs:
      models:
        description: 'Models to sync (comma-separated: tiny,tiny.en,base,base.en,small,small.en)'
        required: false
        default: 'tiny,tiny.en,base,base.en,small,small.en'
  schedule:
    # Monthly check for updates
    - cron: '0 0 1 * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create/checkout browser-models branch
        run: |
          # Create orphan branch if it doesn't exist
          if git show-ref --verify --quiet refs/remotes/origin/browser-models; then
            git checkout browser-models
            git pull origin browser-models
          else
            git checkout --orphan browser-models
            git rm -rf . || true
            echo "# Browser ONNX Models" > README.md
            echo "" >> README.md
            echo "Whisper models for browser-based transcription (transformers.js)." >> README.md
            echo "" >> README.md
            echo "These are mirrored from HuggingFace for networks that block HF." >> README.md
            echo "" >> README.md
            echo "**CDN URL:** \`https://cdn.jsdelivr.net/gh/JerrettDavis/LocalTranscriber@browser-models/\`" >> README.md
            git add README.md
            git commit -m "Initialize browser-models branch"
            git push -u origin browser-models
          fi

      - name: Sync Models
        run: |
          set -e
          
          MODELS="${{ github.event.inputs.models || 'tiny,tiny.en,base,base.en,small,small.en' }}"
          
          # Files to download for each model
          CONFIG_FILES="config.json tokenizer.json tokenizer_config.json preprocessor_config.json generation_config.json vocab.json merges.txt added_tokens.json special_tokens_map.json normalizer.json"
          ONNX_FILES="model_quantized.onnx decoder_model_merged_quantized.onnx encoder_model_quantized.onnx decoder_with_past_model_quantized.onnx"
          
          for MODEL_SUFFIX in ${MODELS//,/ }; do
            MODEL_NAME="whisper-${MODEL_SUFFIX}"
            HF_MODEL="Xenova/${MODEL_NAME}"
            MODEL_DIR="${MODEL_NAME}"
            
            echo ""
            echo "=========================================="
            echo "Processing: ${MODEL_NAME}"
            echo "=========================================="
            
            # Create model directory
            mkdir -p "${MODEL_DIR}/onnx"
            
            # Download config files
            for FILE in ${CONFIG_FILES}; do
              URL="https://huggingface.co/${HF_MODEL}/resolve/main/${FILE}"
              DEST="${MODEL_DIR}/${FILE}"
              
              if curl -fsSL --head "${URL}" 2>/dev/null | grep -q "200"; then
                echo "  ↓ ${FILE}"
                curl -fsSL -o "${DEST}" "${URL}"
              fi
            done
            
            # Download ONNX files
            for FILE in ${ONNX_FILES}; do
              URL="https://huggingface.co/${HF_MODEL}/resolve/main/onnx/${FILE}"
              DEST="${MODEL_DIR}/onnx/${FILE}"
              
              if curl -fsSL --head "${URL}" 2>/dev/null | grep -q "200"; then
                echo "  ↓ onnx/${FILE} (this may take a while...)"
                curl -fsSL -o "${DEST}" "${URL}"
                
                SIZE=$(du -h "${DEST}" | cut -f1)
                echo "    Size: ${SIZE}"
              fi
            done
            
            echo "  ✓ ${MODEL_NAME} complete"
          done
          
          echo ""
          echo "=========================================="
          echo "All models downloaded"
          echo "=========================================="

      - name: Commit and Push
        run: |
          # Add all model files
          git add -A
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync browser models from HuggingFace"
            git push origin browser-models
            echo ""
            echo "Models synced! CDN URL:"
            echo "https://cdn.jsdelivr.net/gh/JerrettDavis/LocalTranscriber@browser-models/"
          fi

      - name: Purge jsDelivr cache
        run: |
          # Purge cache for updated models (best effort)
          MODELS="${{ github.event.inputs.models || 'tiny,tiny.en,base,base.en,small,small.en' }}"
          
          for MODEL_SUFFIX in ${MODELS//,/ }; do
            MODEL_NAME="whisper-${MODEL_SUFFIX}"
            PURGE_URL="https://purge.jsdelivr.net/gh/JerrettDavis/LocalTranscriber@browser-models/${MODEL_NAME}/config.json"
            curl -s "${PURGE_URL}" > /dev/null || true
          done
          
          echo "Cache purge requested"
